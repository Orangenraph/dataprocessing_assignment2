import json
import urllib.request
import pandas as pd
import matplotlib.pyplot as plt

def json_vis():
    # Öffnet URL mit urrlib.  df = pd.read_json(url) führte zu --> ValueError: Mixing dicts with non-Series may lead to ambiguous ordering.
    url = "https://raw.githubusercontent.com/sbrucknerh/dataprocessing_assignment2/main/suicide_rate.json"
    response = urllib.request.urlopen(url)
    data = json.load(response)

    # Erstellt DataFrame filtert nach Geschlecht= [13] / Datum= [15]
    df = pd.DataFrame(data["data"])[[10,13,15,19]]
    # Neue Überschriften
    df.columns = ["Age-adjusted","Gender", "Date", "Dp100k"]

    # wandelt Date in ints
    df["Date"] = pd.to_numeric(df["Date"])
    df["Dp100k"] = pd.to_numeric(df["Dp100k"])


    # Gender wird unterteilt in Male oder Female und wird als Bool gespeichert
    df["Male"] = df["Gender"] == "Male"
    df["Female"] = df["Gender"] == "Female"
    df["Both"] = df["Gender"] == "All persons"

    # Filtert Daten, die keine Geschlechtsangabe haben: 672 von 6390 = ~10% der Daten hatten keine Geschlechtsangabe
    df = df[~((df["Male"] == False) & (df["Female"] == False) & (df["Both"] == False)) & (df["Age-adjusted"] == "1")].reset_index(drop=True) # & kombiniert mehrere Bedingungen in einem df. ~ ist die Verneinung

    # wird nicht mehr benötigt
    df = df.drop(["Gender", "Age-adjusted"], axis=1)

    # Gruppiert Dp100k nach Datum
    df = df.pivot(index="Date", columns=["Male", "Female", "Both"], values="Dp100k").reset_index()

    # benenne und ändere Reihenfolge der Columns
    df.columns = ["Date", "Both", "Male", "Female"]
    df = df[["Date", "Male", "Female", "Both"]]
    df = df.sort_values(by=["Date"], ascending=True)

    # Line Plot
    df.plot(kind = "line", x = "Date", y = ["Male", "Female", "Both"],color = ["blue", "red", "orange"], figsize = (10,10))
    plt.ylabel("Average Deaths per 100,000 resident population")
    plt.legend(["Male", "Female", "Both"])
    plt.show()

    # OPTIONAL
    print(df)
    df.to_json("JSON_Data_Project_5", orient="records", lines=True) # Speichert df als json


json_vis()
